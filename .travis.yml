language: java

os: linux

services:
  - docker
  
env:
  global:
    - HXE_VERSION=2.00.036.00.20190223.1
    - |-
      PASSWORD_FILE_CONTENT='{"master_password" : "L1qu1base_test"}'
    - PASSWORD_FILE_NAME=passwords.json
    #DOCKER_USERNAME
    - secure: "Gjl8jwmzWvsLKmI+o5SUGidFRBvEhPZnQqky12qaJgVohDCg62Y/WYapbJe13Chv264mY7D+CKzjJ9LLO+38KqN+nBZTk9GAK1sb9irOVgOEL0seOz55o1bb8pyuOBkBcjHMbhgIDsRNM47JCg0aTcwKK4VMZt/s4pyW01WVZQ8RCXQLgrFV/Ot7kXQdT79SJFjBPolxh2fWBdfzOxHAjhRJufUCxY+d4mTWhrJLe9ATVZCVg0OSk4OF5sb84zKlBoyQI6Yh/N0Rbq8xrbPvrunAXmOC5y/ovjA3JusF0PkE4asmuHQjYEQbzBr0NjEonIGXW+dwAlJpkNtkYfGwk0WBdD08dWzf0AdPqSprgjM4FcuHb9mM/tFNtdWllhY3k9FJUKV8PYLQPIlJANa0ybqC6K/3XSgNpDt2Uivz0/QUd3MlZp7x/CKEceeNtTx7q970/fbjJ5bewuWVkINH8SUQPdC73p1DIRbauWJ05YKOl/uE+gOfKXHoYdk2q7o+MinhYulqtpcjOX1MRN4FI7aVhLjPi3rbl3GqLCHF5pcBrCM4t6CkH50v8OJnrlCLkXvj4qe8tebXW85Ssp3VXV8gsxpaiVI5G+RzzZhjU2jrfqeO6omLmouEFzXG38+wxUBhSC1Np530O56Wy93vFx5lYg9ox0nsSLe31YPoEl8="
    #DOCKER_PASSWORD
    - secure: "v+LXsUdypmKR8cajkQnfUv1DeIf94AOQdQ6SNlLNdnXAQ4jr6cykPYXuhNnlqJjrTGdXa6dQfVCSWCsb1Q0AXS5bVTZPL7rhW6RxS6xqsiziw/sVaUS37IhxXj+GhdDHW3grR51DbzMNajsLGanYULUmnXEGxs2z/HcqxijvLLrgb+KnpRHCE8P4S63bz0s9Zj0ZegmT7FqJxdKBqXWEjG2PIE8WQJt6PzcDem5tnb6V2NTgwfkS7R3+/lowd2uRVfWfnujyueIwfbz+ijf/Xg2X2FnSBHBlQwEQ2g8KcNCNiZAbYMXqJibLSexnyql6IX3KG2fCCQXGOCv7htFqS4GOsZjGVQgVM1YnFwjphoPdotmE6GDghEqoBOecaDVOehjGgvbondbDXQgfJN1dWseKTyVBgM8fEVUSPUt1912H/4fACfXF1ufiJ+ORo7SCYjuncbsv9ct2vkDXLis3YAQS/q4pRU8E7nedxMQ8F926ASSg7WbfmZBWuar04PkAHC+au0cPG5O5vTzg0VSViQXw1YGIV/OGgoxcTy36xomf/871/Fdma4u0jjP4X5hanb+c4xgmAAyPjumtez9L+x64Npt3S3Xl7W2y0SnHODIZfCeFEGbixzO6XXa3CBHGVPpxckgT6C5oimIsKRLDko2VJmrQv4+ehlOtoOF4R38="    

before_script:
  - mkdir $TRAVIS_BUILD_DIR/HXE
  - chmod -R 777 $TRAVIS_BUILD_DIR/HXE
  - echo $PASSWORD_FILE_CONTENT > $TRAVIS_BUILD_DIR/HXE/$PASSWORD_FILE_NAME
  - chmod 777 $TRAVIS_BUILD_DIR/HXE/$PASSWORD_FILE_NAME
  - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin  
  - docker pull store/saplabs/hanaexpress:$HXE_VERSION
  - docker run -d -p 39013:39013 -p 39015:39015 -p 39017:39017 -p 39041-39045:39041-39045 -p 1128-1129:1128-1129 -p 59013-59014:59013-59014 -v $TRAVIS_BUILD_DIR/HXE:/hana/mounts --ulimit nofile=1048576:1048576 --sysctl kernel.shmmax=1073741824 --sysctl net.ipv4.ip_local_port_range='40000 60999' --sysctl kernel.shmmni=524288 --sysctl kernel.shmall=8388608 --name HXETravisCI store/saplabs/hanaexpress:$HXE_VERSION --passwords-url file:///hana/mounts/$PASSWORD_FILE_NAME --agree-to-sap-license
  - sleep 10
  - |-
    while true; do 
      STARTING_CONTAINERS=`docker ps --filter "name=HXETravisCI" --format "{{.Names}} {{.Status}}" | grep 'health: starting' | wc -l`;
      echo "Waiting for $STARTING_CONTAINERS HANA container(s) to finish startup";
      if [ $STARTING_CONTAINERS -ne 1 ]; then
        break; 
      fi;
      sleep 5; 
    done
  - docker ps -a
  - |-
    docker exec HXETravisCI bash -l -c "hdbsql -u SYSTEM -p L1qu1base_test -i 90 -d HXE 'CREATE USER LIQUIBASE_TEST PASSWORD L1qu1base_test NO FORCE_FIRST_PASSWORD_CHANGE'"
  - docker logout

addons:
  hosts:
  - hxehost
